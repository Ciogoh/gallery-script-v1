let img, originalImg;let input;let lastX, lastY;let currentPalette = 'thermal';let sidebarWidth = 180; // Leggermente pi larga per i nuovi inputlet densitySlider, sizeSlider, gradientSlider;let bgColorPicker;let gradientToggle;let canvasLayer;let stepCount = 0;let wInput, hInput; // Input per dimensioni tavolafunction setup() {  createCanvas(windowWidth, windowHeight);    // Inizializzazione tavola predefinita (formato A4 proporzionale o schermo)  createCanvasLayer(800, 800);    setupUI();  lastX = mouseX;  lastY = mouseY;}function createCanvasLayer(w, h) {  canvasLayer = createGraphics(w, h);  canvasLayer.background(250);}function setupUI() {  let yPos = 20;  const createLabel = (text, y) => {    let l = createP(text);    l.position(20, y);    l.style('font-family', 'Inter, sans-serif');    l.style('font-size', '10px');    l.style('font-weight', 'bold');    l.style('letter-spacing', '1px');    l.style('text-transform', 'uppercase');    l.style('color', '#555');    return l;  };  // 1. DIMENSIONI TAVOLA (Nuova sezione)  createLabel('0. Dimensione Tavola', yPos);  wInput = createInput('800');  wInput.position(20, yPos + 30);  wInput.size(50);  hInput = createInput('800');  hInput.position(85, yPos + 30);  hInput.size(50);    let resizeBtn = createButton('Applica');  resizeBtn.position(20, yPos + 60);  resizeBtn.mousePressed(() => {    if(confirm("Questo cancellerˆ il disegno attuale. Continuare?")) {      createCanvasLayer(int(wInput.value()), int(hInput.value()));    }  });  yPos += 100;  createLabel('1. Carica Immagine', yPos);  input = createFileInput(handleFile);  input.position(20, yPos + 35);  input.size(140);  yPos += 80;  createLabel('2. Palette', yPos);  createPaletteButtons(yPos + 30);  yPos += 180;  createLabel('3. Distanza Scia', yPos);  densitySlider = createSlider(5, 150, 25);  styleSlider(densitySlider, yPos + 30);  yPos += 60;  createLabel('4. Dimensione', yPos);  sizeSlider = createSlider(0.1, 5.0, 0.8, 0.1);  styleSlider(sizeSlider, yPos + 30);  yPos += 60;  createLabel('5. Effetto Gradiente', yPos);  gradientToggle = createCheckbox(' Attiva', false);  gradientToggle.position(20, yPos + 30);  gradientSlider = createSlider(5, 200, 50);  styleSlider(gradientSlider, yPos + 55);  yPos += 90;  createLabel('6. Sfondo', yPos);  bgColorPicker = createColorPicker('#fafafa');  bgColorPicker.position(20, yPos + 35);  bgColorPicker.style('width', '140px');  bgColorPicker.input(() => canvasLayer.background(bgColorPicker.color()));  let info = createP('C: Pulisce | S: Salva PNG');  info.position(20, height - 40);  info.style('font-family', 'sans-serif');  info.style('font-size', '10px');  info.style('color', '#999');}function styleSlider(s, y) {  s.position(20, y);  s.style('width', '140px');}function createPaletteButtons(startY) {  const palNames = ['Thermal', 'Neon', 'B&W', 'Vintage', 'Ocean', 'Forest', 'Sunset'];  const palIDs = ['thermal', 'neon', 'bw', 'vintage', 'ocean', 'forest', 'sunset'];  for (let i = 0; i < palNames.length; i++) {    let btn = createButton(palNames[i]);    let col = i % 2;    let row = floor(i / 2);    btn.position(20 + col * 75, startY + row * 35);    btn.size(70, 28);    btn.style('font-size', '10px');    btn.mousePressed(() => {      currentPalette = palIDs[i];      if (originalImg) { img = originalImg.get(); processImage(img); }    });  }}function draw() {  background(220); // Grigio scuro fuori dalla tavola    // Calcolo per centrare la tavola nella visualizzazione  push();  let previewScale = min((width - sidebarWidth - 40) / canvasLayer.width, (height - 40) / canvasLayer.height);  if (previewScale > 1) previewScale = 1;    translate(sidebarWidth + (width - sidebarWidth) / 2, height / 2);  scale(previewScale);  imageMode(CENTER);    // Ombra della tavola  fill(0, 30);  rect(-canvasLayer.width/2 + 5, -canvasLayer.height/2 + 5, canvasLayer.width, canvasLayer.height);    image(canvasLayer, 0, 0);  pop();    // Sidebar  noStroke();  fill(255);  rect(0, 0, sidebarWidth, height);  stroke(230);  line(sidebarWidth, 0, sidebarWidth, height);    if (img && mouseX > sidebarWidth) drawPreviewCursor();}function drawPreviewCursor() {  push();  noFill();  stroke(100);  strokeWeight(1);  let baseScale = sizeSlider.value();  rectMode(CENTER);  rect(mouseX, mouseY, 40 * baseScale, 40 * baseScale);  pop();}function mousePressed() {  if (mouseX > sidebarWidth && img) {    stepCount = 0;    paintImage();  }}function mouseDragged() {  if (!img || mouseX < sidebarWidth) return;  let d = dist(mouseX, mouseY, lastX, lastY);  if (d > densitySlider.value()) {    stepCount++;    paintImage();    lastX = mouseX; lastY = mouseY;  }}function paintImage() {  // Converti coordinate mouse in coordinate della tavola  let previewScale = min((width - sidebarWidth - 40) / canvasLayer.width, (height - 40) / canvasLayer.height);  if (previewScale > 1) previewScale = 1;    let tx = (mouseX - (sidebarWidth + (width - sidebarWidth) / 2)) / previewScale + canvasLayer.width / 2;  let ty = (mouseY - height / 2) / previewScale + canvasLayer.height / 2;  canvasLayer.push();  canvasLayer.imageMode(CENTER);  canvasLayer.translate(tx, ty);    let baseScale = sizeSlider.value();  let alpha = gradientToggle.checked() ? map(stepCount, 0, gradientSlider.value(), 255, 0, true) : 255;    canvasLayer.tint(255, alpha);  canvasLayer.scale(baseScale);  canvasLayer.image(img, 0, 0);  canvasLayer.pop();}function handleFile(file) {  if (file.type === 'image') {    originalImg = loadImage(file.data, (loaded) => {      loaded.resize(300, 0); // Risoluzione interna della "spazzola"      img = loaded.get();      processImage(img);    });  }}function processImage(p) {  p.loadPixels();  for (let i = 0; i < p.pixels.length; i += 4) {    let r = p.pixels[i], g = p.pixels[i+1], b = p.pixels[i+2];    let avg = (r + g + b) / 3;    if (currentPalette === 'thermal') {      if (avg < 60) { p.pixels[i]=45; p.pixels[i+1]=0; p.pixels[i+2]=180; }      else if (avg < 120) { p.pixels[i]=255; p.pixels[i+1]=0; p.pixels[i+2]=150; }      else if (avg < 190) { p.pixels[i]=0; p.pixels[i+1]=255; p.pixels[i+2]=220; }      else { p.pixels[i]=255; p.pixels[i+1]=255; p.pixels[i+2]=150; }    } else if (currentPalette === 'neon') {      p.pixels[i] = avg > 120 ? 255 : 20; p.pixels[i+1] = 0; p.pixels[i+2] = avg > 120 ? 200 : 255;    } else if (currentPalette === 'ocean') {      p.pixels[i] = 0; p.pixels[i+1] = avg; p.pixels[i+2] = avg + 50;    } else if (currentPalette === 'forest') {      p.pixels[i] = avg/2; p.pixels[i+1] = avg; p.pixels[i+2] = 40;    } else if (currentPalette === 'sunset') {      p.pixels[i] = 255; p.pixels[i+1] = avg; p.pixels[i+2] = 50;    } else if (currentPalette === 'bw') {      p.pixels[i] = p.pixels[i+1] = p.pixels[i+2] = avg;    } else if (currentPalette === 'vintage') {      p.pixels[i] = avg + 30; p.pixels[i+1] = avg; p.pixels[i+2] = avg - 30;    }  }  p.updatePixels();}function keyPressed() {  if (key === 'c' || key === 'C') canvasLayer.background(bgColorPicker.color());  if (key === 's' || key === 'S') save(canvasLayer, 'pixel_art_HQ.png');}